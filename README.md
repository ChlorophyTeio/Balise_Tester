# Balise Tester

面向轨道交通应答器与列车运行的可视化仿真工具，基于 PySide6 与 Matplotlib。提供配置-仿真-运行图全链路功能，适合验证应答器布局、信号逻辑与列车时刻表。

## 功能概览
- 配置管理：可视化创建/编辑/删除应答器、车站、列车及线路总长，自动同步菜单与仿真视图。
- 仿真与可视化：60 FPS 级别刷新，支持平移/缩放、拖动应答器定位、列车跟随视角，实时显示里程、速度、信号。
- 信号与逻辑：手动与计划列车统一遵循信号规则（出口站=红灯、起点/途中=绿灯）；终点行为支持“停止”或“重头运行”循环。
- 应答器呈现：成组应答器自动分配子编号，组名居中标注；无源=空心三角，有源=白色实心三角。
- 运行图预览：Matplotlib LineCollection 优化绘制，滚轮/组合键缩放平移，懒加载车次标签以避免卡顿，可自适应、导出图片。
- 窗口管理：主窗口关闭时，调度、运行图、关于等子窗口自动关闭。

## 快速开始
1. 安装依赖（示例）
   ```bash
   pip install PySide6 matplotlib pandas
   ```
2. 运行主程序（项目根目录）
   ```bash
   python main.py
   ```
3. 进入主界面后，按需配置应答器/车站/列车/线路并启动仿真。

## 配置文件
- data/config/balises.csv：应答器列表（名称、里程、父应答器、类型、信号包等）。
- data/config/stations.json：车站列表（名称、里程、类型等）。
- data/config/trains.json：列车模板（名称、长度、最大速度、终点行为等）。
- data/config/line_config.json：线路总长等全局参数。
- 日志：logs/ 下按日期存储运行日志。

## 使用指南
- 配置操作：
  - 菜单“新增/配置/删除/定位”对应应答器、车站、列车；支持在仿真视图中双击/拖动应答器调整里程。
  - “保存配置”将当前内存模型写回配置文件。
- 仿真控制：
  - 运行/暂停/停止；跟随模式自动跟踪首列车；自适应视图重置缩放。
  - 鼠标滚轮缩放；按住中键平移；Shift/Ctrl+滚轮用于轴向缩放（运行图预览同理）。
- 运行图与调度：
  - 调度窗口可编辑时刻表；运行图预览窗口可查看线路车次走行，支持“自适应大小”“保存图片”。
- 关于窗口：菜单“帮助/关于”查看版本与说明。

## 关键原理
- 仿真循环：`SimulationWidget` 每 ~16 ms 更新列车状态、信号判定与绘制，模拟时钟独立计时。
- 信号判定：出口站（名称含 "CZ" 或配置为终点）下一个区段强制红灯；起点/途中为绿灯；手动列车与计划列车共享逻辑。
- 终点行为：列车到达终点后根据配置执行“停止”或回到起点重新运行，保持速度/位置初始化。
- 应答器分组：按 `father_balise` 分组，缺失子编号自动分配，组大小写入 `n_total`，链路标志 `q_link` 自动生成，组名居中标注。
- 运行图绘制：使用 Matplotlib `LineCollection` 批量渲染线段，散点标记经停，车次标签懒加载，仅在合适缩放下绘制以提升性能。

## 主要模块
- 主窗口与菜单：[balise_tester/main_window.py](balise_tester/main_window.py)
- 仿真与绘制：[balise_tester/widgets/simulation_widget.py](balise_tester/widgets/simulation_widget.py)
- 运行图预览：[balise_tester/windows/map_preview_dialog.py](balise_tester/windows/map_preview_dialog.py)
- 对话框（应答器/车站/列车/线路）：balise_tester/dialogs/*
- UI 文件：ui/*.ui 与生成的 *.py

## 常见问题
- 运行图卡顿：已使用批量绘制和标签懒加载，若数据量极大可在运行图窗口关闭“动态显示车次”。
- 配置未刷新：外部修改 CSV/JSON 后程序会自动重新加载；若未生效可点击“保存配置”或重启应用。

如需进一步定制（协议扩展、更多信号规则等），可在 `balise_tester` 目录下对应模块扩展逻辑。
